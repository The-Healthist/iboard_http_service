# 版本 1.1.0 更新文档

## 📋 更新概述

本次更新主要新增了设备轮播列表同步管理功能、系统配置字段扩展、应用版本管理接口等核心功能，提升了系统的自动化程度和用户体验。

---

## 🆕 新增功能

### 1. 系统配置字段扩展

为 `setting` 表添加了四个新的配置字段，用于优化系统播放行为：

| 字段名 | 类型 | 默认值 | 功能描述 |
|--------|------|--------|----------|
| `AppUpdateDuration` | `int` | 600秒 | 应用更新时间间隔 |
| `PaymentTableOnePageDuration` | `int` | 5秒 | 缴费表格单页停留时间 |
| `NormalToAnnouncementCarouselDuration` | `int` | 10秒 | 正常播放到公告轮播切换时间 |
| `AnnouncementCarouselToFullAdsCarouselDuration` | `int` | 10秒 | 公告轮播到全屏广告轮播切换时间 |

**技术特点**：
- 所有字段均为 `int` 类型，单位统一为秒
- 采用驼峰命名法，符合 Go 语言规范
- 设置合理的默认值，确保系统正常运行

---

### 2. 设备轮播列表管理接口

#### 2.1 管理员轮播管理接口

##### 顶部广告轮播管理

**获取顶部广告轮播列表**
- **接口**: `GET /api/admin/device/carousel/top_advertisements`
- **权限**: 管理员 JWT
- **功能**: 获取设备的顶部广告轮播完整信息列表

**请求参数**:
```json
{
  "deviceID": 1
}
```

**更新顶部广告轮播顺序**
- **接口**: `PUT /api/admin/device/carousel/top_advertisements`
- **权限**: 管理员 JWT
- **功能**: 更新设备顶部广告轮播顺序（全量替换）

**请求参数**:
```json
{
  "deviceID": 1,
  "data": [
    {
      "id": 3,
      "title": "促销广告",
      "description": "限时优惠活动",
      "type": "image",
      "status": "active",
      "duration": 45,
      "priority": 90,
      "startTime": "2024-01-01T00:00:00Z",
      "endTime": "2024-12-31T23:59:59Z",
      "display": "top",
      "fileId": 3,
      "isPublic": true
    }
  ]
}
```

##### 全屏广告轮播管理

**获取全屏广告轮播列表**
- **接口**: `GET /api/admin/device/carousel/full_advertisements`
- **权限**: 管理员 JWT
- **功能**: 获取设备的全屏广告轮播完整信息列表

**更新全屏广告轮播顺序**
- **接口**: `PUT /api/admin/device/carousel/full_advertisements`
- **权限**: 管理员 JWT
- **功能**: 更新设备全屏广告轮播顺序（全量替换）

##### 公告轮播管理

**获取公告轮播列表**
- **接口**: `GET /api/admin/device/carousel/notices`
- **权限**: 管理员 JWT
- **功能**: 获取设备的公告轮播完整信息列表

**更新公告轮播顺序**
- **接口**: `PUT /api/admin/device/carousel/notices`
- **权限**: 管理员 JWT
- **功能**: 更新设备公告轮播顺序（全量替换）

#### 2.2 设备端轮播获取接口

| 接口路径 | 方法 | 权限 | 功能描述 |
|----------|------|------|----------|
| `/api/device/client/carousel/top_advertisements` | GET | 设备 JWT | 获取顶部广告轮播列表 |
| `/api/device/client/carousel/full_advertisements` | GET | 设备 JWT | 获取全屏广告轮播列表 |
| `/api/device/client/carousel/notices` | GET | 设备 JWT | 获取公告轮播列表 |

**响应数据特点**：
- 返回完整的数据结构信息
- 按自定义顺序排列
- 包含关联的文件信息

---

### 3. 应用版本管理接口

#### 3.1 公开版本获取接口
- **接口**: `GET /api/app/version`
- **权限**: 公开访问
- **功能**: 获取当前应用版本配置信息，包含当前使用的版本详情

**响应数据**:
```json
{
  "data": {
    "id": 1,
    "currentVersionId": 2,
    "currentVersion": {
      "id": 2,
      "versionNumber": "1.1.0",
      "buildNumber": "002",
      "description": "修复已知问题，优化用户体验",
      "downloadUrl": "https://example.com/downloads/app-v1.1.0.apk",
      "status": "active"
    },
    "lastCheckTime": "2024-01-20T10:00:00Z",
    "updateInterval": 3600,
    "autoUpdate": false,
    "status": "active",
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-20T10:00:00Z"
  },
  "message": "Get app version config success"
}
```

#### 3.2 应用版本配置更新接口
- **接口**: `PUT /api/admin/app/version`
- **权限**: 管理员 JWT
- **功能**: 更新应用版本配置，包括设置当前使用的版本

**请求参数示例**:
```json
{
  "id": 1,
  "currentVersionId": 2,
  "updateInterval": 7200,
  "autoUpdate": true,
  "status": "active"
}
```

**响应数据**:
```json
{
  "message": "update app version config success",
  "data": {
    "id": 1,
    "currentVersionId": 2,
    "currentVersion": {
      "id": 2,
      "versionNumber": "1.1.0",
      "buildNumber": "002",
      "description": "修复已知问题，优化用户体验",
      "downloadUrl": "https://example.com/downloads/app-v1.1.0.apk",
      "status": "active"
    },
    "lastCheckTime": "2024-01-20T10:00:00Z",
    "updateInterval": 7200,
    "autoUpdate": true,
    "status": "active",
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-20T10:00:00Z"
  }
}
```

---

### 4. 版本管理接口（管理员）

#### 4.1 版本 CRUD 操作

**创建版本**
- **接口**: `POST /api/admin/version`
- **权限**: 管理员 JWT
- **功能**: 创建新的应用版本

**请求参数示例**:
```json
{
  "versionNumber": "1.1.1",
  "buildNumber": "002",
  "description": "新增功能特性，提升用户体验",
  "downloadUrl": "https://example.com/downloads/app-v1.1.1.apk",
  "status": "active"
}
```

**获取版本列表**
- **接口**: `GET /api/admin/versions`
- **权限**: 管理员 JWT
- **功能**: 获取所有版本信息列表

**获取单个版本**
- **接口**: `GET /api/admin/version/:id`
- **权限**: 管理员 JWT
- **功能**: 根据ID获取特定版本信息

**更新版本**
- **接口**: `PUT /api/admin/version`
- **权限**: 管理员 JWT
- **功能**: 更新版本信息

**删除版本**
- **接口**: `DELETE /api/admin/version/:id`
- **权限**: 管理员 JWT
- **功能**: 删除指定版本（不能删除当前使用的版本）

**获取活跃版本**
- **接口**: `GET /api/admin/versions/active`
- **权限**: 管理员 JWT
- **功能**: 获取所有状态为活跃的版本列表

---

### 5. 数据模型说明

#### 5.1 App 模型（应用配置）
```go
type App struct {
    ID              uint      `json:"id"`
    CurrentVersionID uint     `json:"currentVersionId"` // 当前使用的版本ID
    CurrentVersion   *Version  `json:"currentVersion"`   // 当前版本信息（关联查询）
    LastCheckTime    time.Time `json:"lastCheckTime"`    // 最后检查更新时间
    UpdateInterval   int       `json:"updateInterval"`   // 检查更新间隔(秒)
    AutoUpdate       bool      `json:"autoUpdate"`       // 是否自动更新
    Status           string    `json:"status"`           // 应用状态
    CreatedAt        time.Time `json:"createdAt"`
    UpdatedAt        time.Time `json:"updatedAt"`
}
```

#### 5.2 Version 模型（版本信息）
```go
type Version struct {
    ID                    uint      `json:"id"`
    VersionNumber         string    `json:"versionNumber"`         // 版本号
    BuildNumber           string    `json:"buildNumber"`           // 构建号
    Description           string    `json:"description"`           // 版本描述
    DownloadUrl           string    `json:"downloadUrl"`           // 下载地址
    Status                string    `json:"status"`                // 状态:active,inactive,deprecated
    CreatedAt             time.Time `json:"createdAt"`
    UpdatedAt             time.Time `json:"updatedAt"`
}
```

---

### 6. 接口设计特点

#### 6.1 公开接口
- **`GET /api/app/version`**: 客户端获取当前版本信息和下载地址
- 无需认证，支持所有用户访问
- 返回完整的版本配置和当前版本详情

#### 6.2 管理员接口
- **`PUT /api/admin/app/version`**: 管理员更新应用配置
- **版本管理**: 完整的版本 CRUD 操作
- 支持版本切换、配置调整等管理功能

#### 6.3 数据关联
- App 模型通过 `CurrentVersionID` 关联到 Version 模型
- 支持预加载查询，一次请求获取完整信息
- 确保数据一致性和完整性


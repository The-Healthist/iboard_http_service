# iBoard通知同步流程

## 概述

iBoard系统需要与旧系统(iSmart)保持通知数据同步。本文档描述了通知同步的完整流程，包括如何处理新增、更新和删除的通知，以及如何避免误解绑手动添加的通知。

## 数据缓存

系统使用Redis缓存以下信息，用于优化同步流程：

- `building_notice_ids:{buildingID}` - 缓存建筑物的通知ID列表
- `building_ismart_notice_count:{buildingID}` - 缓存建筑物的iSmart通知数量
- `building:{buildingID}` - 缓存建筑物信息
- `building_synced_notice_md5:{buildingID}` - 缓存上次同步的通知MD5列表

## 同步流程

### 1. 初始化

1. 从Redis获取建筑物信息和缓存的通知ID
2. 获取上次同步的通知MD5列表
3. 从数据库获取现有的iSmart通知(is_ismart_notice = true)
4. 创建现有通知的MD5映射，便于快速查找

### 2. 获取旧系统数据

1. 向旧系统API发送请求，获取最新的通知列表
2. 提取通知ID，用于后续比较

### 3. 检查是否需要强制同步

1. 比较数据库中的iSmart通知数量与旧系统通知数量
2. 如果数量不匹配，清除缓存并强制同步

### 4. 收集MD5值

1. 并发下载旧系统的所有通知文件
2. 计算每个文件的MD5值
3. 收集所有MD5值，形成新的MD5列表
4. 建立MD5到通知ID的映射关系

### 5. 比较MD5列表

1. 如果缓存的MD5列表存在且与新MD5列表完全匹配，跳过同步
2. 否则，比较新旧MD5列表，找出需要添加和删除的通知：
   - 需要删除的通知：在旧MD5列表中存在但在新MD5列表中不存在
   - 需要添加的通知：在新MD5列表中存在但在旧MD5列表中不存在，或在现有通知中不存在

### 6. 处理删除

对于每个需要删除的MD5：
1. 在现有通知中查找对应的通知
2. 解绑通知与建筑物的关系
3. 检查通知是否绑定到其他建筑物
4. 如果没有其他绑定，删除通知
5. 检查文件是否被其他通知使用
6. 如果没有其他引用，删除文件

### 7. 处理添加

对于每个需要添加的MD5：
1. 查找对应的旧系统通知
2. 检查是否已存在相同MD5的通知：
   - 如果存在且已绑定到当前建筑物，无需操作
   - 如果存在但未绑定到当前建筑物，绑定通知
   - 如果不存在，下载文件并处理通知(上传文件、创建记录、绑定到建筑物)

### 8. 更新缓存

1. 更新缓存的通知ID列表
2. 更新同步的通知MD5列表
3. 更新缓存的通知数量

## 关键优化

### 精确的MD5比对

系统使用MD5值来唯一标识通知文件，这确保了：
1. 即使通知ID变化，只要内容相同，系统也能识别为同一通知
2. 如果内容变化，即使ID相同，系统也会将其视为新通知

### 避免误解绑

通过以下机制避免误解绑手动添加的通知:
1. 系统只会解绑那些在上次同步中存在但在新同步中不存在的通知（基于MD5比对）
2. 手动添加的通知（其MD5不在上次同步列表中）不会被解绑
3. 即使通知内容相同，只要不是来自旧系统的同步，也不会被误解绑

### 通知筛选

系统只同步`is_ismart_notice = true`的通知，确保不会影响新系统的通知。

### 并发处理

1. 动态计算最佳工作线程数，基于通知数量和CPU核心数
2. 使用信号量控制并发，避免资源过度使用
3. 分两阶段并发处理：先收集MD5，再处理需要添加的通知

## 手动同步

系统支持手动触发同步，会清除所有缓存并强制执行完整同步流程。

## 定时同步

系统会定期执行同步操作，间隔时间可通过环境变量配置:

- `NOTICE_SYNC_INTERVAL` - 同步间隔(分钟)
- `NOTICE_SYNC_CACHE_DURATION` - 缓存持续时间(分钟)
- `NOTICE_SYNC_BUILDING_CACHE_DURATION` - 建筑物缓存持续时间(分钟)
- `NOTICE_SYNC_COUNT_CACHE_DURATION` - 通知数量缓存持续时间(分钟)

## 错误处理

系统会记录所有同步过程中的错误，并在同步完成后返回详细的统计信息，包括:

- 成功处理的通知数量
- 已同步的通知数量
- 删除的通知数量
- 失败的通知列表
- 总处理通知数量

## 总结

通过基于MD5的同步方式，系统能够精确地同步旧系统的通知，同时避免误解绑手动添加的通知。这种方法既保证了数据的一致性，又提供了足够的灵活性，特别是在处理手动绑定的通知时。

## 流程图

```
┌─────────────────┐
│     初始化      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 获取旧系统数据  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│检查是否需要强制同步│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   收集MD5值     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  比较MD5列表    │──┐
└────────┬────────┘  │
         │           │
         │           │ 完全匹配
         │           │
         │           ▼
         │      ┌─────────────────┐
         │      │   跳过同步      │
         │      └─────────────────┘
         │
         │ 不匹配
         │
         ▼
┌─────────────────┐
│   处理删除      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   处理添加      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   更新缓存      │
└─────────────────┘
``` 